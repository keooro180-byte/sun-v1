async function handleChat(e) {
    if (e.key === 'Enter') {
        const msg = e.target.value;
        if (!msg.trim()) return;
        const output = document.getElementById('output');
        output.innerHTML += '<div class="user-line">> ' + msg + '</div>';
        e.target.value = '';

        try {
            // التعديل هنا: نرسل الطلب إلى مسار Netlify Functions وليس Cloudflare
            const res = await fetch('/.netlify/functions/chat', { 
                method: 'POST', 
                body: JSON.stringify({message: msg}) 
            });
            const data = await res.json();
            const reply = data.candidates[0].content.parts[0].text;
            output.innerHTML += '<div class="sun-line">[SUN]: ' + reply + '</div>';
        } catch (err) {
            output.innerHTML += '<div style="color:red;">! خطأ: العقل غير متصل. تأكد من وجود ملف functions/chat.js</div>';
        }
        output.scrollTop = output.scrollHeight;
    }
}
